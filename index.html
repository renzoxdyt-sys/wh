<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wehold — Market Ticker</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --burgundy:#7A1523;
      --white:#FFFFFF;
      --wehold-gold:#D4AF37;
      --muted:#B0B7C3;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Montserrat',sans-serif;background:#fff;color:#0A1F44}
    header{height:72px;display:flex;align-items:center;padding:0 24px;position:sticky;top:0;background:transparent;z-index:50}
    .logo{font-weight:700;color:var(--burgundy);font-size:20px}

    /* Ticker wrapper */
    .ticker-wrap{
      position:sticky;
      top:72px;
      z-index:60;
      background:var(--burgundy);
      height:44px;
      display:flex;
      align-items:center;
      overflow:hidden;
      padding-left:8px;
      border-top:1px solid rgba(255,255,255,0.06);
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .ticker{
      display:flex;
      align-items:center;
      white-space:nowrap;
      will-change:transform;
      transition:opacity .25s linear;
      transform: translateX(0);
    }
    .ticker-item{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:0 16px;
      font-weight:500;
      color:var(--white);
      font-size:14px;
      border-left:1px solid rgba(255,255,255,0.06);
    }
    .ticker-item .symbol{font-weight:700}
    .ticker-item .price{min-width:80px;text-align:right;font-weight:700}
    .chg{margin-left:10px;min-width:64px;text-align:right;display:flex;gap:6px;align-items:center;justify-content:flex-end}
    .chg.up{color:#1fb97a}.chg.down{color:#ff6b6b}.chg.flat{color:#cbd5e1}

    @keyframes ticker-scroll { from{transform:translateX(0)} to{transform:translateX(calc(var(--scrollWidth) * -1))} }

    /* responsive */
    @media (max-width:640px){
      .ticker-item{padding:0 10px;font-size:13px}
      .ticker-item .price{min-width:64px}
    }

    /* page content placeholder */
    main{padding:28px}
    .note{color:var(--muted);font-size:14px}
  </style>
</head>
<body>
  <header>
    <div class="logo">Wehold</div>
  </header>

  <div class="ticker-wrap" aria-hidden="false">
    <div id="ticker" class="ticker" role="list" aria-label="Market ticker"></div>
  </div>

  <main>
    <h2>Barra de índices y commodities</h2>
    <p class="note">Datos públicos tomados desde Yahoo Finance (sin API key). Polling cada 30 s; el endpoint está cacheado 30 s en la CDN.</p>
  </main>

  <script>
  (function(){
    const T = document.getElementById('ticker');
    const POLL_INTERVAL = 30000; // 30s, recomendado para evitar exceso de llamadas
    const SPEED_PX_PER_SEC = 60;
    let poller = null;

    function createItem(label, price, changePct){
      const item = document.createElement('div');
      item.className = 'ticker-item';
      const priceText = (price === null || price === undefined) ? '—' : Number(price).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
      let chClass = 'flat';
      let arrow = '→';
      if(typeof changePct === 'number'){
        if (changePct > 0.01){ chClass='up'; arrow='▲'; }
        else if (changePct < -0.01){ chClass='down'; arrow='▼'; }
      }
      const pctHtml = (typeof changePct === 'number') ? `<span class="pct">${(changePct>0?'+':'')+changePct+'%'}</span>` : `<span class="pct"></span>`;
      item.innerHTML = `<span class="symbol">${label}</span><span class="price">${priceText}</span><span class="chg ${chClass}"><span class="arrow">${arrow}</span>${pctHtml}</span>`;
      return item;
    }

    function buildFragment(items){
      const frag = document.createDocumentFragment();
      items.forEach(it => frag.appendChild(createItem(it.label, it.price, it.changePct)));
      // duplicate for seamless scroll
      const clone = frag.cloneNode(true);
      const wrapper = document.createDocumentFragment();
      wrapper.appendChild(frag);
      wrapper.appendChild(clone);
      return wrapper;
    }

    function startAnimation(){
      // reset transform so it starts from left
      T.style.transform = 'translateX(0px)';
      requestAnimationFrame(()=>{
        const totalWidth = T.scrollWidth;
        const half = totalWidth / 2;
        if(!half || !isFinite(half)) return;
        T.style.setProperty('--scrollWidth', half + 'px');
        const duration = Math.max(12, Math.round(half / SPEED_PX_PER_SEC));
        T.style.animation = 'none';
        void T.offsetWidth;
        T.style.animation = `ticker-scroll ${duration}s linear infinite`;
        T.style.opacity = '1';
      });
    }

    async function fetchAndRender(){
      try{
        const r = await fetch('/api/quotes');
        if(!r.ok) throw new Error('quotes failed');
        const j = await r.json();
        const rows = (j && Array.isArray(j.results)) ? j.results : [];

        // map to items: label, price, changePct
        const items = rows.map(x => ({ label: x.label, price: x.price, changePct: x.changePct }));

        // fallback
        if(items.length === 0){
          items.push({ label:'S&P 500', price:4500.12, changePct:0.34 });
          items.push({ label:'Gold (futures)', price:2000.12, changePct:-0.28 });
        }

        // fade out -> replace -> fade in
        T.style.opacity = '0';
        setTimeout(()=>{
          T.innerHTML = '';
          T.appendChild(buildFragment(items));
          startAnimation();
        }, 260);

      } catch(err){
        console.warn('ticker error', err);
        T.style.opacity = '0';
        setTimeout(()=>{
          T.innerHTML = '';
          const mock = [
            { label:'S&P 500', price:4500.12, changePct:0.34 },
            { label:'Gold (futures)', price:2000.12, changePct:-0.28 }
          ];
          T.appendChild(buildFragment(mock));
          startAnimation();
        },260);
      }
    }

    // initial + poll
    fetchAndRender();
    poller = setInterval(fetchAndRender, POLL_INTERVAL);

    window.addEventListener('resize', ()=> {
      if(window._tickerResizeTO) clearTimeout(window._tickerResizeTO);
      window._tickerResizeTO = setTimeout(()=> fetchAndRender(), 300);
    });
    window.addEventListener('beforeunload', ()=> clearInterval(poller));
  })();
  </script>
</body>
</html>
